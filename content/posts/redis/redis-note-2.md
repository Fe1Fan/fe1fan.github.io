---
title: "Redis 笔记2：架构"
date: 2020-10-07T14:23:52+08:00
tags: [redis]
math: true
---
<!--more-->

## 1.0 架构

![00015.jpg](https://i.loli.net/2021/05/26/8h1KHfMXNaAbsL9.jpg)

这套结构被称为文件事件处理器，基于Reactor模式，采用I/O多路服用的程序同时监听多个套接字。

当被监听的套接字准备好执行链接应答、读取、写入、关闭等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件
处理器来处理这些事件。

- I/O多路复用程序
- 文件事件分派器
- 文件事件处理器

当文件事件触发时，I/O多路复用程序总会将所有产生事件的套接字都放在一个队列里，然后通过这个队列以有序、同步、
每次一个套接字的方式向文件事件分派器传送套接字。当上一个套接字产生的事件被处理完毕之后（该套接字为事件所关联的事件处理器执行完毕）
I/O多路复用程序才会继续向文件事件分派器传送下一个套接字。


## I/O 多路复用程序

- select
- epoll
- evport
- kqueue

## 文件事件分派器

负责对不同的事件分配不同的事件处理器。
在Redis中，事件有下面几种类型：
- AE_READABLE 当套接字可读时（Client对Server进行write或close）或者有新的套接字可应答时（Client对Server进行connect）
- AE_WRITABLE 当套接字变得可写时。

当可读和可写同时发生时，先处理可读套接字，在处理可写套接字。

## 文件事件处理器
- 链接应答处理器
- 命令请求处理器
- 命令回复处理器

## 执行命令过程分析
- Server监听套接字的AE_READABLE事件正在处于监听之下，该事件所对应的处理器为连接应答处理器。
- Client发起连接，监听套接字产生AE_READABLE事件，触发链接应答处理器执行。
- Client发起命令执行请求，套接字产生AE_READABLE事件，命令请求处理器执行。
- Server将Client套接字的AE_WRITABLE事件与命令回复处理器进行关联。
- Client尝试读取命令回复的时候，Client套接字产生AE_WRITABLE事件，触发命令回复处理器执行。
- Server将命令回复全部写入套接字后，Server解除客户端套接字的AE_WRITABLE事件与命令回复处理器之间的关联。
