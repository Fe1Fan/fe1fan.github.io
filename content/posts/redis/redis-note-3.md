---
title: "Redis 笔记3：时间事件处理器"
date: 2020-10-07T14:23:52+08:00
tags: [redis]
math: true
---
<!--more-->

## 1.0 时间处理器
Redis李很多非响应命令的功能，例如持久化、内存淘汰、复制、cluster等，需要设置一个定时任务执行，
本文主要介绍Redis的事件处理器的结构功能。

时间事件主要分为以下两种：
- 定时事件
- 周期性事件

一个时间事件主要有以下三个属性组成：

- id
  
  服务器为事件创建的全局唯一ID，ID从小到大递增。
- when
  
  毫秒精度的UNIX时间戳，记录了事件事件的到达时间。
- timeProc

  时间事件处理器，一个函数，当事件时间到达时，无夫妻就会调用相应的处理器来处理事件。

服务器将所有的时间事件放在一个无序链表中，每当时间事件执行器运行时，遍历整个链表，查找出已到达时间的事件，并调用相应的事件处理器。
当添加时间事件时，将插入链表的第一个位置。


## 2.0 应用 serverCron

serverCron 的主要工作包括以下内容：

- 更新服务器的各类统计信息，比如时间、内存占用、数据库占用等。
- 清理数据库中的过期键值对。
- 关闭和清理连接失效的客户端。
- 尝试进行AOF或RDB持久化操作。
- 如果服务器时主服务器，那么对从服务器进行定期同步。
- 如果处于集群模式，对集群进行定期同步和连接测试

serverCron函数时周期性事件，每秒运行次数通过conf文件重的hz选项。

## 事件的调度与执行
因为Redis时单线程且同时存在文件事件和时间事件两种事件类型，所以Redis必须对两种事件进行调度，决定何时处理以及花多长事件处理。

![00008.jpg](https://i.loli.net/2021/05/26/cRDLjC23aZoGrYu.jpg)

## 过期删除策略

- 惰性删除 在取出key的时候进行过期检查。
- 定期删除 每隔一段时间抽出一批key执行删除过期操作。

采用的是 定期删除+惰性删除 。


## Redis 内存淘汰机制
- volatile-lru： 从已设置的过期时间数据集中，挑选最近最少使用。
- volatile-ttl： 从已设置过期时间的数据集中，挑选将要过期的数据淘汰。
- volatile-random：从已设置过期时间的数据集中，任意选择数据淘汰。
- allkeys-lru：当内存不足时，一处最近最少使用的key。
- allkeys-random：从数据集中任意选择数据淘汰。
- no-eviction：禁止写入数据。

- volatile-lfu：从已设置过期时间的数据集，中挑选最不经常使用的数据淘汰
- allkeys-lfu：当内存不足以容纳新写入数据时，在键空间中，移除最不经常使用的 key
