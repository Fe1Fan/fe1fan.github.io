<!doctype html><html><head><title>Redis 笔记3：时间事件处理器 // Fe1Fan</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="学习笔记"><meta property="og:title" content="Redis 笔记3：时间事件处理器"><meta property="og:description" content="学习笔记"><meta property="og:type" content="website"><meta property="og:locale" content="en"><meta property="og:url" content="https://fe1.fan/posts/redis/redis-note-3/"><link rel="shortcut icon" href=/favicon.ico><link href=https://fe1.fan/webfonts/ptserif/main.css rel=stylesheet type=text/css><link href=https://fe1.fan/webfonts/source-code-pro/main.css rel=stylesheet type=text/css><link rel=stylesheet href=https://fe1.fan/css/style.css><meta name=generator content="Hugo 0.75.1"></head><body><div id=container><header id=header><div id=header-outer class=outer><div id=header-inner class=inner><a id=main-nav-toggle class=nav-icon href=javascript:;></a><a id=logo class=logo-text href=https://fe1.fan/>Fe1Fan</a><nav id=main-nav><a class=main-nav-link href=/>主页</a>
<a class=main-nav-link href=/tags/>归档</a>
<a class=main-nav-link href=/about/>关于</a>
<a class=main-nav-link href=/index.xml>订阅</a></nav><nav id=sub-nav><div id=search-form-wrap></div></nav></div></div></header><section id=main class=outer><article class="article article-type-post" itemscope itemprop=blogPost><div class=article-inner><header class=article-header><h1 class=article-title itemprop=name>Redis 笔记3：时间事件处理器</h1></header><div class=article-meta><a href="/posts/redis/redis-note-3/?uid=ce6181fbd4e47cc49d8d1ad8dddccc86" class=article-date><time datetime=2020-10-07T14:23:52.000+08:00 itemprop=datePublished>2020-10-07</time></a></div><div class=article-entry itemprop=articleBody><h2 id=10-时间处理器>1.0 时间处理器</h2><p>Redis李很多非响应命令的功能，例如持久化、内存淘汰、复制、cluster等，需要设置一个定时任务执行，
本文主要介绍Redis的事件处理器的结构功能。</p><p>时间事件主要分为以下两种：</p><ul><li>定时事件</li><li>周期性事件</li></ul><p>一个时间事件主要有以下三个属性组成：</p><ul><li><p>id</p><p>服务器为事件创建的全局唯一ID，ID从小到大递增。</p></li><li><p>when</p><p>毫秒精度的UNIX时间戳，记录了事件事件的到达时间。</p></li><li><p>timeProc</p><p>时间事件处理器，一个函数，当事件时间到达时，无夫妻就会调用相应的处理器来处理事件。</p></li></ul><p>服务器将所有的时间事件放在一个无序链表中，每当时间事件执行器运行时，遍历整个链表，查找出已到达时间的事件，并调用相应的事件处理器。
当添加时间事件时，将插入链表的第一个位置。</p><h2 id=20-应用-servercron>2.0 应用 serverCron</h2><p>serverCron 的主要工作包括以下内容：</p><ul><li>更新服务器的各类统计信息，比如时间、内存占用、数据库占用等。</li><li>清理数据库中的过期键值对。</li><li>关闭和清理连接失效的客户端。</li><li>尝试进行AOF或RDB持久化操作。</li><li>如果服务器时主服务器，那么对从服务器进行定期同步。</li><li>如果处于集群模式，对集群进行定期同步和连接测试</li></ul><p>serverCron函数时周期性事件，每秒运行次数通过conf文件重的hz选项。</p><h2 id=事件的调度与执行>事件的调度与执行</h2><p>因为Redis时单线程且同时存在文件事件和时间事件两种事件类型，所以Redis必须对两种事件进行调度，决定何时处理以及花多长事件处理。</p><p><img src=https://i.loli.net/2021/05/26/cRDLjC23aZoGrYu.jpg alt=00008.jpg></p><h2 id=过期删除策略>过期删除策略</h2><ul><li>惰性删除 在取出key的时候进行过期检查。</li><li>定期删除 每隔一段时间抽出一批key执行删除过期操作。</li></ul><p>采用的是 定期删除+惰性删除 。</p><h2 id=redis-内存淘汰机制>Redis 内存淘汰机制</h2><ul><li><p>volatile-lru： 从已设置的过期时间数据集中，挑选最近最少使用。</p></li><li><p>volatile-ttl： 从已设置过期时间的数据集中，挑选将要过期的数据淘汰。</p></li><li><p>volatile-random：从已设置过期时间的数据集中，任意选择数据淘汰。</p></li><li><p>allkeys-lru：当内存不足时，一处最近最少使用的key。</p></li><li><p>allkeys-random：从数据集中任意选择数据淘汰。</p></li><li><p>no-eviction：禁止写入数据。</p></li><li><p>volatile-lfu：从已设置过期时间的数据集，中挑选最不经常使用的数据淘汰</p></li><li><p>allkeys-lfu：当内存不足以容纳新写入数据时，在键空间中，移除最不经常使用的 key</p></li></ul></div><div class=article-toc><h3>Contents</h3><nav id=TableOfContents><ul><li><a href=#10-时间处理器>1.0 时间处理器</a></li><li><a href=#20-应用-servercron>2.0 应用 serverCron</a></li><li><a href=#事件的调度与执行>事件的调度与执行</a></li><li><a href=#过期删除策略>过期删除策略</a></li><li><a href=#redis-内存淘汰机制>Redis 内存淘汰机制</a></li></ul></nav></div><footer class=article-footer><ul class=article-tag-list><li class=article-tag-list-item><a class=article-tag-list-link href=https://fe1.fan/tags/redis>redis</a></li></ul></footer><script>MathJax={tex:{inlineMath:[["$","$"]],},displayMath:[["$$","$$"],["\[\[","\]\]"],],svg:{fontCache:"global",},};</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></div><nav id=article-nav><a href=/posts/redis/redis-note-2/ id=article-nav-newer class=article-nav-link-wrap><div class=article-nav-title><span>&lt;</span>&nbsp;
Redis 笔记2：文件事件处理器</div></a></nav></article></section><footer id=footer><div class=outer><div id=footer-info class=inner>&copy; 2021 Fe1Fan<br>Powered by <a href=https://gohugo.io target=_blank>Hugo</a> with theme <a href=https://github.com/carsonip/hugo-theme-minos target=_blank>Minos</a></div></div><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin=anonymous></script><script>hljs.initHighlightingOnLoad();</script><script>document.getElementById('main-nav-toggle').addEventListener('click',function(){var header=document.getElementById('header');if(header.classList.contains('mobile-on')){header.classList.remove('mobile-on');}else{header.classList.add('mobile-on');}});</script></footer></div></body></html>